<?php 
$data = $block->getFeaturedProducts();
if ($data != null) {
    $category_name = $data['categoryName'];
    $pageSize = $block->getProductCount();
    $page = intval($block->getRequest()->getParam('p')) ?: 1;
    $formKey = $block->getRequest()->getParam('formKey');
    $defaultCurrencySymbol = $block->getDefaultCurrencySymbol();
    $products = $data['products'];
    $itemsPerPage = $block->getProductCount();
    $totalProducts = count($products);
    $totalPages = ceil($totalProducts / $itemsPerPage);
    // Validate current page
    $currentPage = max(1, min($totalPages, $page));

    // Calculate slice limits for pagination
    $startIndex = ($currentPage - 1) * $itemsPerPage;
    $endIndex = $startIndex + $itemsPerPage;

    // Slice the products array for the current page
    $pagedProducts = array_slice($products, $startIndex, $itemsPerPage);
    
    shuffle($pagedProducts);
} else {
    $totalProducts = 0;
}
?>
<?php if ($totalProducts) : ?>
    <div id="bootstrap-loader" class="text-center" style="display: none;">
    <!-- Bootstrap spinner -->
    <div class="spinner-border" role="status">
        <span class="sr-only">Loading...</span>
    </div>
</div>
    <div class="homepage-featured-products home-wrapper">
        <h1><?php echo $category_name; ?></h1>
        <div class="products-grid row">
            <?php foreach ($pagedProducts as $product) : ?>
                <?php
                $objectManager = \Magento\Framework\App\ObjectManager::getInstance();

                // Get StockRegistryInterface instance
                $stockRegistry = $objectManager->get(\Magento\CatalogInventory\Api\StockRegistryInterface::class);
                
                // Get stock item by product ID
                $stockItem = $stockRegistry->getStockItem($product->getId());

                // Get available quantity
                $stockQty = $stockItem->getQty();

                /* 45854 :: Stock Levels Via API */
                $stock_out_status = "";
                $isohlq = $product->getData('isohlq');
                $bottle_icon = $product->getData('bottleicon');

                $storeScope = \Magento\Store\Model\ScopeInterface::SCOPE_STORE;
                $low_level_qty = $objectManager->get('Magento\Framework\App\Config\ScopeConfigInterface')
                    ->getValue('burstonline_customconfig/product_price_config/low_level_qty', $storeScope);

                $priceConfigEnabled = $objectManager->get('Magento\Framework\App\Config\ScopeConfigInterface')
                    ->getValue('burstonline_customconfig/product_price_config/active', $storeScope);

                $sale_limit = $objectManager->get('Magento\Framework\App\Config\ScopeConfigInterface')
                ->getValue('burstonline_customconfig/product_price_config/sale_limit', $storeScope);

                    if (!empty($isohlq)){
                        if ($bottle_icon <= -1) {
                            $stock_out_status = "Out of Stock";
                        }
                        else if ($bottle_icon == 0) {
                            $stock_out_status = "Low Stock";
                        }
                        else 
                        {
                            $stock_out_status = "In Stock";
                        }
                    }
                    else{
                        if($stockQty == "null" || $stockQty == null){
                                $stock_out_status = "Not available for sale online";
                        }
                        else if($stockQty <= 0){
                            $stock_out_status = "Out of Stock";
                        }
                        else if($stockQty > 0 && $stockQty <= $low_level_qty){
                            $stock_out_status = "Low Stock";
                        }
                        else if($stockQty > $low_level_qty){
                            $stock_out_status = "In Stock";
                        }
                    }
                /* 45854 :: Stock Levels Via API */
                ?>
                <?php if($priceConfigEnabled == 1 && $product->getPrice() > $sale_limit){
                    $stock_out_status = "Not available for sale online";
                }
                ?> 
                <?php if (!$product->isAvailable()  || ($stock_out_status == "Out of Stock" || $stock_out_status == "Not available for sale online")):?>
                <?php else : ?>
                <div class="col-md-4 mt-5">
                    <div class="product-item1 h-100">
                   
                        <img class="prod-img box1" src="<?php echo $block->getImageHelper()->init($product, 'product_page_image_large')->getUrl(); ?>" alt="<?php echo $block->escapeHtml($product->getName()); ?>"   data-url="<?php echo $product->getProductUrl(); ?>"/>

                        <?php
                        // Get average rating and total reviews
                        $ratingandreviews = $block->getReviewsAndAverageRating($product);
                        $rating = $ratingandreviews['average_rating'];
                        $totalReviews = $ratingandreviews['reviews_count'];
                        // echo $rating;
                        ?>
                        <div class="prod-details box1">
                            <div>
                                <p class="prod-head"> <a href="<?php echo $product->getProductUrl(); ?>" class=""><?php echo $block->escapeHtml($product->getName()); ?>
                                    </a>

                                </p>
                                <div class="rating1">
                                    <?php

                                    // Total stars
                                    $totalStars = 5;

                                    // Full stars count
                                    $fullStars = floor($rating);

                                    // Fractional part (empty star)
                                    $fraction = $rating - $fullStars;

                                    // Generate full stars
                                    for ($i = 0; $i < $fullStars; $i++) {
                                        echo '<span class="star1">&#9733;</span>';
                                    }

                                    // If there's a fractional part, add an empty star
                                    if ($fraction > 0) {
                                        echo '<span class="star2">&#9733;</span>';
                                    }

                                    // Generate remaining empty stars
                                    for ($i = 0; $i < $totalStars - ceil($rating); $i++) {
                                        echo '<span class="star2">&#9733;</span>';
                                    }
                                    ?>
                                    <span class="prod-rev"><?php echo $totalReviews; ?> Review(s)</span>
                                </div>
                                <!-- <p class="price"><?php echo $defaultCurrencySymbol; ?><?php echo number_format($block->escapeHtml($product->getPrice())); ?></p> -->
                                <?php
                                // Example usage assuming $defaultCurrencySymbol is defined elsewhere
                                $productPrice = $product->getPrice(); // Retrieve product price
                                $formattedPrice = number_format($productPrice, 2); // Format price with two decimal places

                                // Output HTML with formatted price and currency symbol
                                ?>
                                <p class="price">
                                    <?php echo $defaultCurrencySymbol; ?>
                                    <?php echo $formattedPrice; ?>
                                </p>
                            </div>
                            <form class="add-to-cart-form" action="<?php echo $block->getUrl('checkout/cart/add'); ?>" method="post">
                                <input type="hidden" name="product" value="<?php echo $product->getId(); ?>" />
                                <input type="hidden" name="form_key" value="<?php echo $formKey; ?>" />
                                    <button type="submit" class="home-cart-btn" title="<?php echo __('Add to Cart'); ?>">
                                        <?php echo __('Add to Cart'); ?>
                                    </button>
                            </form>
                        </div>
                    </div>
                </div>
                <?php endif; ?>

            <?php endforeach; ?>

        </div>
        <?php if ($totalPages > 1) : ?>

            <div class="pagination pagination-home">
                <div class="pager">

                    <div class="pages">
                        <ul class="items pages-items">
                            <?php if ($currentPage > 1) : ?>
                                <li class="item pages-item-previous">
                                    <a href="?p=<?php echo ($currentPage - 1); ?>" class="action  previous" data-page="<?php echo ($currentPage - 1); ?>"></a>
                                </li>
                            <?php endif; ?>
                            <?php for ($i = 1; $i <= $totalPages; $i++) : ?>
                                <li class="<?php echo ($i == $currentPage) ? 'item current' : 'item'; ?>">
                                    <?php if ($i == $currentPage) : ?>
                                        <strong class="page">
                                            <!-- <a href="?page=<?php echo $i; ?>"> -->
                                            <span><?php echo $i; ?></span>
                                            <!-- </a> -->
                                        </strong>
                                    <?php else : ?>
                                        <a href="?p=<?php echo $i; ?>" class="page"  data-page="<?php echo $i; ?>">
                                            <?php echo $i; ?>
                                        </a>
                                    <?php endif; ?>


                                </li>
                            <?php endfor; ?>
                            <?php if ($currentPage < $totalPages) : ?>
                                <li class="item pages-item-next">
                                    <a href="?p=<?php echo ($currentPage + 1); ?>" class="action  next" data-page="<?php echo ($currentPage + 1); ?>"></a>
                                </li>
                            <?php endif; ?>

                        </ul>

                    </div>
                </div>

            </div>

        <?php endif; ?>
    </div>
<?php endif; ?>

